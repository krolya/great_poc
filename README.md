# Приложение "Более нормальный человек"

Приложение построено на основе [Streamlit](https://streamlit.io) и реализует два основных функционала: генерацию персонажей для целевой аудитории и анализ рекламных сообщений.

---

## Краткое описание

- **Генерация персон:**  
  На основе шаблонов промтов, загружаемых с GitHub, происходит динамическая подстановка параметров целевой аудитории (например, возраст, доход, регион, образование, семейное положение, количество детей и т.д.). Полученные запросы отправляются в OpenAI API, а сгенерированные описания персонажей сохраняются в Airtable.

- **Анализ рекламы:**  
  Отобранные персоны фильтруются по заданным критериям. Для каждой записи формируются промты (также загружаемые с GitHub), которые отправляются в OpenAI API с использованием JSON-схемы для валидации. Результаты анализа (оценки по понятности, доверительности, разнообразию и месседжу) загружаются обратно в Airtable и отображаются в удобном виде.

---

## Технические подробности реализации

- **Архитектура и основные технологии:**  
  - **Streamlit:**  
    Обеспечивает веб-интерфейс, управление вкладками, формами и отображением данных.
    
  - **OpenAI API:**  
    Используется для генерации описаний персон и анализа рекламы. В зависимости от выбранной модели (например, "gpt-4o" или DeepSeek-модели) применяется основной ключ (OPENAI_API_KEY) или альтернативный (NEBIUS_API_KEY) с изменённым базовым URL.
    
  - **Airtable API:**  
    Через библиотеку [pyairtable](https://github.com/gtalarico/pyairtable) происходит загрузка, выборка и обновление данных в базе, включая персонажи и результаты анализа.
    
  - **GitHub:**  
    Файлы с промтами и JSON-схемой загружаются динамически через HTTP-запросы с использованием токена `GITHUB_API_TOKEN`.
    
  - **Параллельная обработка:**  
    Для ускорения анализа рекламы применяется многопоточность с использованием `ThreadPoolExecutor`, что позволяет разбивать список персон на чанки и обрабатывать их одновременно.

- **Работа с шаблонами и подстановка параметров:**  
  Функция `parse_prompt()` заменяет заполнители в шаблонах промтов на актуальные значения (например, уникальные идентификаторы, параметры аудитории и данные о рекламе). Файлы с промтами загружаются с помощью функции `get_file_from_github()`.

- **Управление секретами и аутентификацией:**  
  Все чувствительные данные хранятся в `st.secrets` и используются для доступа к OpenAI, Airtable и GitHub, что обеспечивает безопасное взаимодействие с внешними сервисами.

---

## Список используемых секретов (st.secrets)

- **GITHUB_API_TOKEN**  
  Токен для авторизации запросов к GitHub. Используется для загрузки шаблонов промтов и JSON-схем из репозитория.

- **OPENAI_API_KEY**  
  Ключ доступа к OpenAI API для генерации текстов (описаний персон и анализа рекламы).

- **NEBIUS_API_KEY**  
  Альтернативный ключ для работы с DeepSeek API, применяется, если выбран deepseek-модель.

- **AIRTABLE_API_TOKEN**  
  Токен для доступа к Airtable API, обеспечивающий загрузку и выборку данных из базы.

- **AIRTABLE_BASE_ID**  
  Идентификатор базы данных Airtable, в которой хранятся записи по персонам и результатам анализа.

- **AIRTABLE_TABLE_ID**  
  Идентификатор таблицы Airtable, используемой при фильтрации и выборке данных для анализа.

---

## Файлы из GitHub

- **person_generation_system.promt**  
  Шаблон системного промта для генерации персон, содержащий базовые инструкции для модели.

- **person_generation.promt**  
  Шаблон пользовательского промта для генерации персон, в который подставляются динамические параметры (например, возраст, доход, регион).

- **ad_analysis_system.promt**  
  Шаблон системного промта для анализа рекламы, задающий основные правила и установки для обработки запроса.

- **ad_analysis.promt**  
  Шаблон пользовательского промта для анализа рекламы, в который подставляются данные о персоне и рекламном сообщении.

- **ad_analysis.json**  
  JSON-схема для валидации структуры ответов от OpenAI API при анализе рекламы (используется в bare-режиме анализа).

---

## Заключение

Приложение объединяет динамическое формирование промтов, интеграцию с OpenAI, Airtable и GitHub, а также использование многопоточности для эффективной обработки данных. Секреты, указанные в `st.secrets`, и файлы с GitHub обеспечивают безопасное и гибкое взаимодействие с внешними сервисами, что делает систему удобной для настройки и масштабирования.
